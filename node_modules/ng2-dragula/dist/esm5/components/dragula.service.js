/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { Group } from '../Group';
import { Subject } from 'rxjs';
import { filter, map } from 'rxjs/operators';
import { EventTypes, AllEvents } from '../EventTypes';
import { DrakeFactory } from '../DrakeFactory';
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
var filterEvent = function (eventType, filterDragType, projector) { return function (input) {
    return input.pipe(filter(function (_a) {
        var event = _a.event, name = _a.name;
        return event === eventType
            && (filterDragType === undefined || name === filterDragType);
    }), map(function (_a) {
        var name = _a.name, args = _a.args;
        return projector(name, args);
    }));
}; };
var ɵ0 = filterEvent;
/** @type {?} */
var elContainerSourceProjector = function (name, _a) {
    var _b = tslib_1.__read(_a, 3), el = _b[0], container = _b[1], source = _b[2];
    return ({ name: name, el: el, container: container, source: source });
};
var ɵ1 = elContainerSourceProjector;
var DragulaService = /** @class */ (function () {
    function DragulaService(drakeFactory) {
        if (drakeFactory === void 0) { drakeFactory = null; }
        var _this = this;
        this.drakeFactory = drakeFactory;
        this.dispatch$ = new Subject();
        this.drag = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.Drag, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 2), el = _b[0], source = _b[1];
            return ({ name: name, el: el, source: source });
        })); };
        this.dragend = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.DragEnd, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 1), el = _b[0];
            return ({ name: name, el: el });
        })); };
        this.drop = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.Drop, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 4), el = _b[0], target = _b[1], source = _b[2], sibling = _b[3];
            return { name: name, el: el, target: target, source: source, sibling: sibling };
        })); };
        this.elContainerSource = function (eventType) {
            return function (groupName) {
                return _this.dispatch$.pipe(filterEvent(eventType, groupName, elContainerSourceProjector));
            };
        };
        this.cancel = this.elContainerSource(EventTypes.Cancel);
        this.remove = this.elContainerSource(EventTypes.Remove);
        this.shadow = this.elContainerSource(EventTypes.Shadow);
        this.over = this.elContainerSource(EventTypes.Over);
        this.out = this.elContainerSource(EventTypes.Out);
        this.cloned = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.Cloned, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 3), clone = _b[0], original = _b[1], cloneType = _b[2];
            return { name: name, clone: clone, original: original, cloneType: cloneType };
        })); };
        this.dropModel = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.DropModel, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 9), el = _b[0], target = _b[1], source = _b[2], sibling = _b[3], item = _b[4], sourceModel = _b[5], targetModel = _b[6], sourceIndex = _b[7], targetIndex = _b[8];
            return { name: name, el: el, target: target, source: source, sibling: sibling, item: item, sourceModel: sourceModel, targetModel: targetModel, sourceIndex: sourceIndex, targetIndex: targetIndex };
        })); };
        this.removeModel = function (groupName) { return _this.dispatch$.pipe(filterEvent(EventTypes.RemoveModel, groupName, function (name, _a) {
            var _b = tslib_1.__read(_a, 6), el = _b[0], container = _b[1], source = _b[2], item = _b[3], sourceModel = _b[4], sourceIndex = _b[5];
            return { name: name, el: el, container: container, source: source, item: item, sourceModel: sourceModel, sourceIndex: sourceIndex };
        })); };
        this.groups = {};
        if (this.drakeFactory === null) {
            this.drakeFactory = new DrakeFactory();
        }
    }
    /**
     * Public mainly for testing purposes. Prefer `createGroup()`.
     * @param {?} group
     * @return {?}
     */
    DragulaService.prototype.add = /**
     * Public mainly for testing purposes. Prefer `createGroup()`.
     * @param {?} group
     * @return {?}
     */
    function (group) {
        /** @type {?} */
        var existingGroup = this.find(group.name);
        if (existingGroup) {
            throw new Error('Group named: "' + group.name + '" already exists.');
        }
        this.groups[group.name] = group;
        this.handleModels(group);
        this.setupEvents(group);
        return group;
    };
    /**
     * @param {?} name
     * @return {?}
     */
    DragulaService.prototype.find = /**
     * @param {?} name
     * @return {?}
     */
    function (name) {
        return this.groups[name];
    };
    /**
     * @param {?} name
     * @return {?}
     */
    DragulaService.prototype.destroy = /**
     * @param {?} name
     * @return {?}
     */
    function (name) {
        /** @type {?} */
        var group = this.find(name);
        if (!group) {
            return;
        }
        group.drake && group.drake.destroy();
        delete this.groups[name];
    };
    /**
     * Creates a group with the specified name and options.
     *
     * Note: formerly known as `setOptions`
     * @template T
     * @param {?} name
     * @param {?} options
     * @return {?}
     */
    DragulaService.prototype.createGroup = /**
     * Creates a group with the specified name and options.
     *
     * Note: formerly known as `setOptions`
     * @template T
     * @param {?} name
     * @param {?} options
     * @return {?}
     */
    function (name, options) {
        return this.add(new Group(name, this.drakeFactory.build([], options), options));
    };
    /**
     * @param {?} __0
     * @return {?}
     */
    DragulaService.prototype.handleModels = /**
     * @param {?} __0
     * @return {?}
     */
    function (_a) {
        var _this = this;
        var name = _a.name, drake = _a.drake, options = _a.options;
        /** @type {?} */
        var dragElm;
        /** @type {?} */
        var dragIndex;
        /** @type {?} */
        var dropIndex;
        drake.on('remove', function (el, container, source) {
            if (!drake.models) {
                return;
            }
            /** @type {?} */
            var sourceModel = drake.models[drake.containers.indexOf(source)];
            sourceModel = sourceModel.slice(0);
            /** @type {?} */
            var item = sourceModel.splice(dragIndex, 1)[0];
            // console.log('REMOVE');
            // console.log(sourceModel);
            // console.log('REMOVE');
            // console.log(sourceModel);
            _this.dispatch$.next({
                event: EventTypes.RemoveModel,
                name: name,
                args: [el, container, source, item, sourceModel, dragIndex]
            });
        });
        drake.on('drag', function (el, source) {
            if (!drake.models) {
                return;
            }
            dragElm = el;
            dragIndex = _this.domIndexOf(el, source);
        });
        drake.on('drop', function (dropElm, target, source, sibling) {
            if (!drake.models || !target) {
                return;
            }
            dropIndex = _this.domIndexOf(dropElm, target);
            /** @type {?} */
            var sourceModel = drake.models[drake.containers.indexOf(source)];
            /** @type {?} */
            var targetModel = drake.models[drake.containers.indexOf(target)];
            /** @type {?} */
            var item;
            if (target === source) {
                sourceModel = sourceModel.slice(0);
                item = sourceModel.splice(dragIndex, 1)[0];
                sourceModel.splice(dropIndex, 0, item);
                // this was true before we cloned and updated sourceModel,
                // but targetModel still has the old value
                targetModel = sourceModel;
            }
            else {
                /** @type {?} */
                var isCopying = dragElm !== dropElm;
                item = sourceModel[dragIndex];
                if (isCopying) {
                    if (!options.copyItem) {
                        throw new Error("If you have enabled `copy` on a group, you must provide a `copyItem` function.");
                    }
                    item = options.copyItem(item);
                }
                if (!isCopying) {
                    sourceModel = sourceModel.slice(0);
                    sourceModel.splice(dragIndex, 1);
                }
                targetModel = targetModel.slice(0);
                targetModel.splice(dropIndex, 0, item);
                if (isCopying) {
                    try {
                        target.removeChild(dropElm);
                    }
                    catch (e) { }
                }
            }
            _this.dispatch$.next({
                event: EventTypes.DropModel,
                name: name,
                args: [dropElm, target, source, sibling, item, sourceModel, targetModel, dragIndex, dropIndex]
            });
        });
    };
    /**
     * @param {?} group
     * @return {?}
     */
    DragulaService.prototype.setupEvents = /**
     * @param {?} group
     * @return {?}
     */
    function (group) {
        var _this = this;
        if (group.initEvents) {
            return;
        }
        group.initEvents = true;
        /** @type {?} */
        var name = group.name;
        /** @type {?} */
        var that = this;
        /** @type {?} */
        var emitter = function (event) {
            group.drake.on(event, function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                _this.dispatch$.next({ event: event, name: name, args: args });
            });
        };
        AllEvents.forEach(emitter);
    };
    /**
     * @param {?} child
     * @param {?} parent
     * @return {?}
     */
    DragulaService.prototype.domIndexOf = /**
     * @param {?} child
     * @param {?} parent
     * @return {?}
     */
    function (child, parent) {
        return Array.prototype.indexOf.call(parent.children, child);
    };
    /** @nocollapse */
    DragulaService.ctorParameters = function () { return [
        { type: DrakeFactory, decorators: [{ type: Optional }] }
    ]; };
DragulaService.ɵfac = function DragulaService_Factory(t) { return new (t || DragulaService)(ɵngcc0.ɵɵinject(DrakeFactory, 8)); };
DragulaService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: DragulaService, factory: function (t) { return DragulaService.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(DragulaService, [{
        type: Injectable
    }], function () { return [{ type: DrakeFactory, decorators: [{
                type: Optional
            }] }]; }, null); })();
    return DragulaService;
}());
export { DragulaService };
function DragulaService_tsickle_Closure_declarations() {
    /** @type {?} */
    DragulaService.prototype.dispatch$;
    /** @type {?} */
    DragulaService.prototype.drag;
    /** @type {?} */
    DragulaService.prototype.dragend;
    /** @type {?} */
    DragulaService.prototype.drop;
    /** @type {?} */
    DragulaService.prototype.elContainerSource;
    /** @type {?} */
    DragulaService.prototype.cancel;
    /** @type {?} */
    DragulaService.prototype.remove;
    /** @type {?} */
    DragulaService.prototype.shadow;
    /** @type {?} */
    DragulaService.prototype.over;
    /** @type {?} */
    DragulaService.prototype.out;
    /** @type {?} */
    DragulaService.prototype.cloned;
    /** @type {?} */
    DragulaService.prototype.dropModel;
    /** @type {?} */
    DragulaService.prototype.removeModel;
    /** @type {?} */
    DragulaService.prototype.groups;
    /** @type {?} */
    DragulaService.prototype.drakeFactory;
}
export { ɵ0, ɵ1 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNwcm8va3JpdHNhZGVlL1NWTi9DeWJlcnNvZnQvYXBleC9ub2RlX21vZHVsZXMvbmcyLWRyYWd1bGEvZGlzdC9lc201L2NvbXBvbmVudHMvZHJhZ3VsYS5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7O0FBWUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O01BMFFNLEFBR0E7Ozs7Ozs7Ozs7O2tDQUlHIiwiZmlsZSI6ImRyYWd1bGEuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGVvdmVydmlldyBhZGRlZCBieSB0c2lja2xlXG4gKiBAc3VwcHJlc3Mge2NoZWNrVHlwZXN9IGNoZWNrZWQgYnkgdHNjXG4gKi9cbmltcG9ydCAqIGFzIHRzbGliXzEgZnJvbSBcInRzbGliXCI7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgR3JvdXAgfSBmcm9tICcuLi9Hcm91cCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEV2ZW50VHlwZXMsIEFsbEV2ZW50cyB9IGZyb20gJy4uL0V2ZW50VHlwZXMnO1xuaW1wb3J0IHsgRHJha2VGYWN0b3J5IH0gZnJvbSAnLi4vRHJha2VGYWN0b3J5Jztcbi8qKiBAdHlwZSB7P30gKi9cbnZhciBmaWx0ZXJFdmVudCA9IGZ1bmN0aW9uIChldmVudFR5cGUsIGZpbHRlckRyYWdUeXBlLCBwcm9qZWN0b3IpIHsgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCkge1xuICAgIHJldHVybiBpbnB1dC5waXBlKGZpbHRlcihmdW5jdGlvbiAoX2EpIHtcbiAgICAgICAgdmFyIGV2ZW50ID0gX2EuZXZlbnQsIG5hbWUgPSBfYS5uYW1lO1xuICAgICAgICByZXR1cm4gZXZlbnQgPT09IGV2ZW50VHlwZVxuICAgICAgICAgICAgJiYgKGZpbHRlckRyYWdUeXBlID09PSB1bmRlZmluZWQgfHwgbmFtZSA9PT0gZmlsdGVyRHJhZ1R5cGUpO1xuICAgIH0pLCBtYXAoZnVuY3Rpb24gKF9hKSB7XG4gICAgICAgIHZhciBuYW1lID0gX2EubmFtZSwgYXJncyA9IF9hLmFyZ3M7XG4gICAgICAgIHJldHVybiBwcm9qZWN0b3IobmFtZSwgYXJncyk7XG4gICAgfSkpO1xufTsgfTtcbnZhciDJtTAgPSBmaWx0ZXJFdmVudDtcbi8qKiBAdHlwZSB7P30gKi9cbnZhciBlbENvbnRhaW5lclNvdXJjZVByb2plY3RvciA9IGZ1bmN0aW9uIChuYW1lLCBfYSkge1xuICAgIHZhciBfYiA9IHRzbGliXzEuX19yZWFkKF9hLCAzKSwgZWwgPSBfYlswXSwgY29udGFpbmVyID0gX2JbMV0sIHNvdXJjZSA9IF9iWzJdO1xuICAgIHJldHVybiAoeyBuYW1lOiBuYW1lLCBlbDogZWwsIGNvbnRhaW5lcjogY29udGFpbmVyLCBzb3VyY2U6IHNvdXJjZSB9KTtcbn07XG52YXIgybUxID0gZWxDb250YWluZXJTb3VyY2VQcm9qZWN0b3I7XG52YXIgRHJhZ3VsYVNlcnZpY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gRHJhZ3VsYVNlcnZpY2UoZHJha2VGYWN0b3J5KSB7XG4gICAgICAgIGlmIChkcmFrZUZhY3RvcnkgPT09IHZvaWQgMCkgeyBkcmFrZUZhY3RvcnkgPSBudWxsOyB9XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHRoaXMuZHJha2VGYWN0b3J5ID0gZHJha2VGYWN0b3J5O1xuICAgICAgICB0aGlzLmRpc3BhdGNoJCA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICAgIHRoaXMuZHJhZyA9IGZ1bmN0aW9uIChncm91cE5hbWUpIHsgcmV0dXJuIF90aGlzLmRpc3BhdGNoJC5waXBlKGZpbHRlckV2ZW50KEV2ZW50VHlwZXMuRHJhZywgZ3JvdXBOYW1lLCBmdW5jdGlvbiAobmFtZSwgX2EpIHtcbiAgICAgICAgICAgIHZhciBfYiA9IHRzbGliXzEuX19yZWFkKF9hLCAyKSwgZWwgPSBfYlswXSwgc291cmNlID0gX2JbMV07XG4gICAgICAgICAgICByZXR1cm4gKHsgbmFtZTogbmFtZSwgZWw6IGVsLCBzb3VyY2U6IHNvdXJjZSB9KTtcbiAgICAgICAgfSkpOyB9O1xuICAgICAgICB0aGlzLmRyYWdlbmQgPSBmdW5jdGlvbiAoZ3JvdXBOYW1lKSB7IHJldHVybiBfdGhpcy5kaXNwYXRjaCQucGlwZShmaWx0ZXJFdmVudChFdmVudFR5cGVzLkRyYWdFbmQsIGdyb3VwTmFtZSwgZnVuY3Rpb24gKG5hbWUsIF9hKSB7XG4gICAgICAgICAgICB2YXIgX2IgPSB0c2xpYl8xLl9fcmVhZChfYSwgMSksIGVsID0gX2JbMF07XG4gICAgICAgICAgICByZXR1cm4gKHsgbmFtZTogbmFtZSwgZWw6IGVsIH0pO1xuICAgICAgICB9KSk7IH07XG4gICAgICAgIHRoaXMuZHJvcCA9IGZ1bmN0aW9uIChncm91cE5hbWUpIHsgcmV0dXJuIF90aGlzLmRpc3BhdGNoJC5waXBlKGZpbHRlckV2ZW50KEV2ZW50VHlwZXMuRHJvcCwgZ3JvdXBOYW1lLCBmdW5jdGlvbiAobmFtZSwgX2EpIHtcbiAgICAgICAgICAgIHZhciBfYiA9IHRzbGliXzEuX19yZWFkKF9hLCA0KSwgZWwgPSBfYlswXSwgdGFyZ2V0ID0gX2JbMV0sIHNvdXJjZSA9IF9iWzJdLCBzaWJsaW5nID0gX2JbM107XG4gICAgICAgICAgICByZXR1cm4geyBuYW1lOiBuYW1lLCBlbDogZWwsIHRhcmdldDogdGFyZ2V0LCBzb3VyY2U6IHNvdXJjZSwgc2libGluZzogc2libGluZyB9O1xuICAgICAgICB9KSk7IH07XG4gICAgICAgIHRoaXMuZWxDb250YWluZXJTb3VyY2UgPSBmdW5jdGlvbiAoZXZlbnRUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGdyb3VwTmFtZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5kaXNwYXRjaCQucGlwZShmaWx0ZXJFdmVudChldmVudFR5cGUsIGdyb3VwTmFtZSwgZWxDb250YWluZXJTb3VyY2VQcm9qZWN0b3IpKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuY2FuY2VsID0gdGhpcy5lbENvbnRhaW5lclNvdXJjZShFdmVudFR5cGVzLkNhbmNlbCk7XG4gICAgICAgIHRoaXMucmVtb3ZlID0gdGhpcy5lbENvbnRhaW5lclNvdXJjZShFdmVudFR5cGVzLlJlbW92ZSk7XG4gICAgICAgIHRoaXMuc2hhZG93ID0gdGhpcy5lbENvbnRhaW5lclNvdXJjZShFdmVudFR5cGVzLlNoYWRvdyk7XG4gICAgICAgIHRoaXMub3ZlciA9IHRoaXMuZWxDb250YWluZXJTb3VyY2UoRXZlbnRUeXBlcy5PdmVyKTtcbiAgICAgICAgdGhpcy5vdXQgPSB0aGlzLmVsQ29udGFpbmVyU291cmNlKEV2ZW50VHlwZXMuT3V0KTtcbiAgICAgICAgdGhpcy5jbG9uZWQgPSBmdW5jdGlvbiAoZ3JvdXBOYW1lKSB7IHJldHVybiBfdGhpcy5kaXNwYXRjaCQucGlwZShmaWx0ZXJFdmVudChFdmVudFR5cGVzLkNsb25lZCwgZ3JvdXBOYW1lLCBmdW5jdGlvbiAobmFtZSwgX2EpIHtcbiAgICAgICAgICAgIHZhciBfYiA9IHRzbGliXzEuX19yZWFkKF9hLCAzKSwgY2xvbmUgPSBfYlswXSwgb3JpZ2luYWwgPSBfYlsxXSwgY2xvbmVUeXBlID0gX2JbMl07XG4gICAgICAgICAgICByZXR1cm4geyBuYW1lOiBuYW1lLCBjbG9uZTogY2xvbmUsIG9yaWdpbmFsOiBvcmlnaW5hbCwgY2xvbmVUeXBlOiBjbG9uZVR5cGUgfTtcbiAgICAgICAgfSkpOyB9O1xuICAgICAgICB0aGlzLmRyb3BNb2RlbCA9IGZ1bmN0aW9uIChncm91cE5hbWUpIHsgcmV0dXJuIF90aGlzLmRpc3BhdGNoJC5waXBlKGZpbHRlckV2ZW50KEV2ZW50VHlwZXMuRHJvcE1vZGVsLCBncm91cE5hbWUsIGZ1bmN0aW9uIChuYW1lLCBfYSkge1xuICAgICAgICAgICAgdmFyIF9iID0gdHNsaWJfMS5fX3JlYWQoX2EsIDkpLCBlbCA9IF9iWzBdLCB0YXJnZXQgPSBfYlsxXSwgc291cmNlID0gX2JbMl0sIHNpYmxpbmcgPSBfYlszXSwgaXRlbSA9IF9iWzRdLCBzb3VyY2VNb2RlbCA9IF9iWzVdLCB0YXJnZXRNb2RlbCA9IF9iWzZdLCBzb3VyY2VJbmRleCA9IF9iWzddLCB0YXJnZXRJbmRleCA9IF9iWzhdO1xuICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogbmFtZSwgZWw6IGVsLCB0YXJnZXQ6IHRhcmdldCwgc291cmNlOiBzb3VyY2UsIHNpYmxpbmc6IHNpYmxpbmcsIGl0ZW06IGl0ZW0sIHNvdXJjZU1vZGVsOiBzb3VyY2VNb2RlbCwgdGFyZ2V0TW9kZWw6IHRhcmdldE1vZGVsLCBzb3VyY2VJbmRleDogc291cmNlSW5kZXgsIHRhcmdldEluZGV4OiB0YXJnZXRJbmRleCB9O1xuICAgICAgICB9KSk7IH07XG4gICAgICAgIHRoaXMucmVtb3ZlTW9kZWwgPSBmdW5jdGlvbiAoZ3JvdXBOYW1lKSB7IHJldHVybiBfdGhpcy5kaXNwYXRjaCQucGlwZShmaWx0ZXJFdmVudChFdmVudFR5cGVzLlJlbW92ZU1vZGVsLCBncm91cE5hbWUsIGZ1bmN0aW9uIChuYW1lLCBfYSkge1xuICAgICAgICAgICAgdmFyIF9iID0gdHNsaWJfMS5fX3JlYWQoX2EsIDYpLCBlbCA9IF9iWzBdLCBjb250YWluZXIgPSBfYlsxXSwgc291cmNlID0gX2JbMl0sIGl0ZW0gPSBfYlszXSwgc291cmNlTW9kZWwgPSBfYls0XSwgc291cmNlSW5kZXggPSBfYls1XTtcbiAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IG5hbWUsIGVsOiBlbCwgY29udGFpbmVyOiBjb250YWluZXIsIHNvdXJjZTogc291cmNlLCBpdGVtOiBpdGVtLCBzb3VyY2VNb2RlbDogc291cmNlTW9kZWwsIHNvdXJjZUluZGV4OiBzb3VyY2VJbmRleCB9O1xuICAgICAgICB9KSk7IH07XG4gICAgICAgIHRoaXMuZ3JvdXBzID0ge307XG4gICAgICAgIGlmICh0aGlzLmRyYWtlRmFjdG9yeSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5kcmFrZUZhY3RvcnkgPSBuZXcgRHJha2VGYWN0b3J5KCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogUHVibGljIG1haW5seSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4gUHJlZmVyIGBjcmVhdGVHcm91cCgpYC5cbiAgICAgKiBAcGFyYW0gez99IGdyb3VwXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuYWRkID0gLyoqXG4gICAgICogUHVibGljIG1haW5seSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4gUHJlZmVyIGBjcmVhdGVHcm91cCgpYC5cbiAgICAgKiBAcGFyYW0gez99IGdyb3VwXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoZ3JvdXApIHtcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgZXhpc3RpbmdHcm91cCA9IHRoaXMuZmluZChncm91cC5uYW1lKTtcbiAgICAgICAgaWYgKGV4aXN0aW5nR3JvdXApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JvdXAgbmFtZWQ6IFwiJyArIGdyb3VwLm5hbWUgKyAnXCIgYWxyZWFkeSBleGlzdHMuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ncm91cHNbZ3JvdXAubmFtZV0gPSBncm91cDtcbiAgICAgICAgdGhpcy5oYW5kbGVNb2RlbHMoZ3JvdXApO1xuICAgICAgICB0aGlzLnNldHVwRXZlbnRzKGdyb3VwKTtcbiAgICAgICAgcmV0dXJuIGdyb3VwO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHs/fSBuYW1lXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuZmluZCA9IC8qKlxuICAgICAqIEBwYXJhbSB7P30gbmFtZVxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JvdXBzW25hbWVdO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHs/fSBuYW1lXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuZGVzdHJveSA9IC8qKlxuICAgICAqIEBwYXJhbSB7P30gbmFtZVxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgZ3JvdXAgPSB0aGlzLmZpbmQobmFtZSk7XG4gICAgICAgIGlmICghZ3JvdXApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBncm91cC5kcmFrZSAmJiBncm91cC5kcmFrZS5kZXN0cm95KCk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmdyb3Vwc1tuYW1lXTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBncm91cCB3aXRoIHRoZSBzcGVjaWZpZWQgbmFtZSBhbmQgb3B0aW9ucy5cbiAgICAgKlxuICAgICAqIE5vdGU6IGZvcm1lcmx5IGtub3duIGFzIGBzZXRPcHRpb25zYFxuICAgICAqIEB0ZW1wbGF0ZSBUXG4gICAgICogQHBhcmFtIHs/fSBuYW1lXG4gICAgICogQHBhcmFtIHs/fSBvcHRpb25zXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuY3JlYXRlR3JvdXAgPSAvKipcbiAgICAgKiBDcmVhdGVzIGEgZ3JvdXAgd2l0aCB0aGUgc3BlY2lmaWVkIG5hbWUgYW5kIG9wdGlvbnMuXG4gICAgICpcbiAgICAgKiBOb3RlOiBmb3JtZXJseSBrbm93biBhcyBgc2V0T3B0aW9uc2BcbiAgICAgKiBAdGVtcGxhdGUgVFxuICAgICAqIEBwYXJhbSB7P30gbmFtZVxuICAgICAqIEBwYXJhbSB7P30gb3B0aW9uc1xuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkKG5ldyBHcm91cChuYW1lLCB0aGlzLmRyYWtlRmFjdG9yeS5idWlsZChbXSwgb3B0aW9ucyksIG9wdGlvbnMpKTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7P30gX18wXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuaGFuZGxlTW9kZWxzID0gLyoqXG4gICAgICogQHBhcmFtIHs/fSBfXzBcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIGZ1bmN0aW9uIChfYSkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB2YXIgbmFtZSA9IF9hLm5hbWUsIGRyYWtlID0gX2EuZHJha2UsIG9wdGlvbnMgPSBfYS5vcHRpb25zO1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBkcmFnRWxtO1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBkcmFnSW5kZXg7XG4gICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgdmFyIGRyb3BJbmRleDtcbiAgICAgICAgZHJha2Uub24oJ3JlbW92ZScsIGZ1bmN0aW9uIChlbCwgY29udGFpbmVyLCBzb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICghZHJha2UubW9kZWxzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICAgICAgdmFyIHNvdXJjZU1vZGVsID0gZHJha2UubW9kZWxzW2RyYWtlLmNvbnRhaW5lcnMuaW5kZXhPZihzb3VyY2UpXTtcbiAgICAgICAgICAgIHNvdXJjZU1vZGVsID0gc291cmNlTW9kZWwuc2xpY2UoMCk7XG4gICAgICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgICAgICB2YXIgaXRlbSA9IHNvdXJjZU1vZGVsLnNwbGljZShkcmFnSW5kZXgsIDEpWzBdO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1JFTU9WRScpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc291cmNlTW9kZWwpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1JFTU9WRScpO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc291cmNlTW9kZWwpO1xuICAgICAgICAgICAgX3RoaXMuZGlzcGF0Y2gkLm5leHQoe1xuICAgICAgICAgICAgICAgIGV2ZW50OiBFdmVudFR5cGVzLlJlbW92ZU1vZGVsLFxuICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgYXJnczogW2VsLCBjb250YWluZXIsIHNvdXJjZSwgaXRlbSwgc291cmNlTW9kZWwsIGRyYWdJbmRleF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgZHJha2Uub24oJ2RyYWcnLCBmdW5jdGlvbiAoZWwsIHNvdXJjZSkge1xuICAgICAgICAgICAgaWYgKCFkcmFrZS5tb2RlbHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkcmFnRWxtID0gZWw7XG4gICAgICAgICAgICBkcmFnSW5kZXggPSBfdGhpcy5kb21JbmRleE9mKGVsLCBzb3VyY2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgZHJha2Uub24oJ2Ryb3AnLCBmdW5jdGlvbiAoZHJvcEVsbSwgdGFyZ2V0LCBzb3VyY2UsIHNpYmxpbmcpIHtcbiAgICAgICAgICAgIGlmICghZHJha2UubW9kZWxzIHx8ICF0YXJnZXQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkcm9wSW5kZXggPSBfdGhpcy5kb21JbmRleE9mKGRyb3BFbG0sIHRhcmdldCk7XG4gICAgICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgICAgICB2YXIgc291cmNlTW9kZWwgPSBkcmFrZS5tb2RlbHNbZHJha2UuY29udGFpbmVycy5pbmRleE9mKHNvdXJjZSldO1xuICAgICAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICAgICAgdmFyIHRhcmdldE1vZGVsID0gZHJha2UubW9kZWxzW2RyYWtlLmNvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXQpXTtcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgICAgIHZhciBpdGVtO1xuICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gc291cmNlKSB7XG4gICAgICAgICAgICAgICAgc291cmNlTW9kZWwgPSBzb3VyY2VNb2RlbC5zbGljZSgwKTtcbiAgICAgICAgICAgICAgICBpdGVtID0gc291cmNlTW9kZWwuc3BsaWNlKGRyYWdJbmRleCwgMSlbMF07XG4gICAgICAgICAgICAgICAgc291cmNlTW9kZWwuc3BsaWNlKGRyb3BJbmRleCwgMCwgaXRlbSk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcyB3YXMgdHJ1ZSBiZWZvcmUgd2UgY2xvbmVkIGFuZCB1cGRhdGVkIHNvdXJjZU1vZGVsLFxuICAgICAgICAgICAgICAgIC8vIGJ1dCB0YXJnZXRNb2RlbCBzdGlsbCBoYXMgdGhlIG9sZCB2YWx1ZVxuICAgICAgICAgICAgICAgIHRhcmdldE1vZGVsID0gc291cmNlTW9kZWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgICAgICAgICAgdmFyIGlzQ29weWluZyA9IGRyYWdFbG0gIT09IGRyb3BFbG07XG4gICAgICAgICAgICAgICAgaXRlbSA9IHNvdXJjZU1vZGVsW2RyYWdJbmRleF07XG4gICAgICAgICAgICAgICAgaWYgKGlzQ29weWluZykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuY29weUl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIklmIHlvdSBoYXZlIGVuYWJsZWQgYGNvcHlgIG9uIGEgZ3JvdXAsIHlvdSBtdXN0IHByb3ZpZGUgYSBgY29weUl0ZW1gIGZ1bmN0aW9uLlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtID0gb3B0aW9ucy5jb3B5SXRlbShpdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFpc0NvcHlpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTW9kZWwgPSBzb3VyY2VNb2RlbC5zbGljZSgwKTtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTW9kZWwuc3BsaWNlKGRyYWdJbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRhcmdldE1vZGVsID0gdGFyZ2V0TW9kZWwuc2xpY2UoMCk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0TW9kZWwuc3BsaWNlKGRyb3BJbmRleCwgMCwgaXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKGlzQ29weWluZykge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUNoaWxkKGRyb3BFbG0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7IH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfdGhpcy5kaXNwYXRjaCQubmV4dCh7XG4gICAgICAgICAgICAgICAgZXZlbnQ6IEV2ZW50VHlwZXMuRHJvcE1vZGVsLFxuICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgYXJnczogW2Ryb3BFbG0sIHRhcmdldCwgc291cmNlLCBzaWJsaW5nLCBpdGVtLCBzb3VyY2VNb2RlbCwgdGFyZ2V0TW9kZWwsIGRyYWdJbmRleCwgZHJvcEluZGV4XVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHs/fSBncm91cFxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLnNldHVwRXZlbnRzID0gLyoqXG4gICAgICogQHBhcmFtIHs/fSBncm91cFxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKGdyb3VwKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIGlmIChncm91cC5pbml0RXZlbnRzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZ3JvdXAuaW5pdEV2ZW50cyA9IHRydWU7XG4gICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgdmFyIG5hbWUgPSBncm91cC5uYW1lO1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgZW1pdHRlciA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgZ3JvdXAuZHJha2Uub24oZXZlbnQsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgX3RoaXMuZGlzcGF0Y2gkLm5leHQoeyBldmVudDogZXZlbnQsIG5hbWU6IG5hbWUsIGFyZ3M6IGFyZ3MgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgQWxsRXZlbnRzLmZvckVhY2goZW1pdHRlcik7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBAcGFyYW0gez99IGNoaWxkXG4gICAgICogQHBhcmFtIHs/fSBwYXJlbnRcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIERyYWd1bGFTZXJ2aWNlLnByb3RvdHlwZS5kb21JbmRleE9mID0gLyoqXG4gICAgICogQHBhcmFtIHs/fSBjaGlsZFxuICAgICAqIEBwYXJhbSB7P30gcGFyZW50XG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoY2hpbGQsIHBhcmVudCkge1xuICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChwYXJlbnQuY2hpbGRyZW4sIGNoaWxkKTtcbiAgICB9O1xuICAgIERyYWd1bGFTZXJ2aWNlLmRlY29yYXRvcnMgPSBbXG4gICAgICAgIHsgdHlwZTogSW5qZWN0YWJsZSB9XG4gICAgXTtcbiAgICAvKiogQG5vY29sbGFwc2UgKi9cbiAgICBEcmFndWxhU2VydmljZS5jdG9yUGFyYW1ldGVycyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIFtcbiAgICAgICAgeyB0eXBlOiBEcmFrZUZhY3RvcnksIGRlY29yYXRvcnM6IFt7IHR5cGU6IE9wdGlvbmFsIH1dIH1cbiAgICBdOyB9O1xuICAgIHJldHVybiBEcmFndWxhU2VydmljZTtcbn0oKSk7XG5leHBvcnQgeyBEcmFndWxhU2VydmljZSB9O1xuZnVuY3Rpb24gRHJhZ3VsYVNlcnZpY2VfdHNpY2tsZV9DbG9zdXJlX2RlY2xhcmF0aW9ucygpIHtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLmRpc3BhdGNoJDtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLmRyYWc7XG4gICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgIERyYWd1bGFTZXJ2aWNlLnByb3RvdHlwZS5kcmFnZW5kO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuZHJvcDtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLmVsQ29udGFpbmVyU291cmNlO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuY2FuY2VsO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUucmVtb3ZlO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuc2hhZG93O1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUub3ZlcjtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLm91dDtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLmNsb25lZDtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLmRyb3BNb2RlbDtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgRHJhZ3VsYVNlcnZpY2UucHJvdG90eXBlLnJlbW92ZU1vZGVsO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuZ3JvdXBzO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBEcmFndWxhU2VydmljZS5wcm90b3R5cGUuZHJha2VGYWN0b3J5O1xufVxuZXhwb3J0IHsgybUwLCDJtTEgfTtcbiJdfQ==